{% extends "index.html" %} {% block head_extra %}{% endblock %} {% block content
%}
<div class="flex items-center justify-center min-h-screen" id="login-container">
  <div class="w-full max-w-md">
    <fieldset class="card glass border-base-300 rounded-box border p-4">
      <div class="card-body">
        <!-- ===== LOGIN VIEW ===== -->
        <section id="view-login" data-view>
          <h2 class="text-2xl font-bold text-center mb-8">Welcome</h2>
          
          {% if error %}
          <div class="alert alert-error mb-4">
            <span>{{ error }}</span>
          </div>
          {% endif %}

          <form
            id="auth-form"
            hx-post="/login"
            hx-target="#login-response"
            hx-swap="innerHTML"
            hx-on:submit="clearOtherResponses('login-response')"
          >
            <div class="form-control mb-4">
              <input
                class="input input-bordered rounded-none glass w-full"
                id="login-username"
                name="username"
                type="email"
                placeholder="Email Address"
                autocomplete="email"
                required
              />
            </div>

            <div class="form-control mb-2">
              <input
                class="input input-bordered rounded-none glass w-full"
                id="login-password"
                name="password"
                type="password"
                placeholder="Password"
                autocomplete="current-password"
                minlength="8"
                required
              />
              <i
                class="fas fa-eye toggle-password absolute right-[66px] translate-y-[100%] cursor-pointer"
                aria-label="Toggle password visibility"
                onclick="
                      (function(p, icon){
                        if (p.type === 'password') {
                          p.type = 'text';
                          icon.classList.remove('fa-eye');
                          icon.classList.add('fa-eye-slash');
                        } else {
                          p.type = 'password';
                          icon.classList.remove('fa-eye-slash');
                          icon.classList.add('fa-eye');
                        }
                      })(document.getElementById('login-password'), this)"
              ></i>
            </div>

            <div id="forgot-container" class="ml-1 mb-4" aria-live="polite">
              <a
                class="link link-hover text-sm font-bold"
                onclick="toggleView('reset')"
              >
                Forgot Password?
              </a>
            </div>

            <button
              type="submit"
              class="btn btn-primary rounded-lg w-full mt-3"
            >
              <i class="fas fa-right-to-bracket"></i>
              Log in with Password
            </button>

            <!-- Server response target for LOGIN only -->
            <div id="login-response" class="mt-2 text-center"></div>
          </form>

          <div class="divider">OR</div>

          <!-- Magic link: outside the form; include only the email field -->
          <button
            type="button"
            class="btn btn-secondary rounded-lg w-full"
            hx-post="/magic-login"
            hx-include="#login-username"
            hx-params="username"
            hx-indicator="#login-indicator"
            hx-on:click="
              const e = document.getElementById('login-username');
              if (!e.checkValidity()) { e.reportValidity(); event.preventDefault(); }
              clearOtherResponses('magic-response');
            "
            hx-target="#magic-response"
            hx-swap="innerHTML"
          >
            <i class="fas fa-link"></i> Send Magic Link
          </button>

          <div id="magic-response" class="mt-2 text-center"></div>
        </section>

        <!-- ===== RESET VIEW ===== -->
        <section id="view-reset" data-view class="hidden">
          <h2 class="text-2xl font-bold text-center mb-4">Forgot Password</h2>

          <p class="text-center mb-8">
            Enter your email address and we'll send you a link to reset your
            password.
          </p>

          <form
            class="mt-4 space-y-4"
            hx-post="/forgot-password"
            hx-target="#reset-response"
            hx-swap="innerHTML"
            hx-on:submit="clearOtherResponses('reset-response')"
          >
            <div class="form-group form-control mb-6">
              <label for="reset-username" class="label sr-only"
                >Email Address</label
              >
              <input
                class="input input-bordered rounded-none glass w-full"
                type="email"
                id="reset-username"
                name="username"
                placeholder="Email Address"
                required
                autofocus
              />
            </div>

            <div class="form-group form-control">
              <button class="btn btn-primary rounded-lg w-full" type="submit">
                <i class="fas fa-link"></i> Send reset link
              </button>
            </div>

            <!-- Server response target for RESET only -->
            <div id="reset-response" class="mt-2 text-center"></div>
          </form>

          <div class="divider">OR</div>
          <button
            class="btn rounded-lg w-full"
            type="button"
            onclick="toggleView('login')"
          >
            Back to Login
          </button>
        </section>

        <!-- ===== PASSWORD RESET VIEW ===== -->
        <section id="view-password-reset" data-view class="hidden">
          <h2 class="text-2xl font-bold text-center mb-4">Reset Password</h2>

          <p class="text-center mb-8">Enter your new password below.</p>

          <form
            class="mt-4 space-y-4"
            hx-post="/reset-password"
            hx-target="#password-reset-response"
            hx-swap="innerHTML"
            hx-on:submit="clearOtherResponses('password-reset-response')"
          >
            <input
              type="hidden"
              id="reset-token"
              name="token"
              value="{{ reset_token or '' }}"
            />

            <div class="form-group form-control mb-4 relative">
              <label for="new-password" class="label sr-only"
                >New Password</label
              >
              <input
                class="input input-bordered rounded-none glass w-full pr-12"
                type="password"
                id="new-password"
                name="new_password"
                placeholder="New Password"
                minlength="8"
                required
                autofocus
              />
              <i
                class="fas fa-eye toggle-password absolute right-3 top-1/2 transform -translate-y-1/2 cursor-pointer"
                aria-label="Toggle new password visibility"
                onclick="
                      (function(p, icon){
                        if (p.type === 'password') {
                          p.type = 'text';
                          icon.classList.remove('fa-eye');
                          icon.classList.add('fa-eye-slash');
                        } else {
                          p.type = 'password';
                          icon.classList.remove('fa-eye-slash');
                          icon.classList.add('fa-eye');
                        }
                      })(document.getElementById('new-password'), this)"
              ></i>
            </div>

            <div class="form-group form-control mb-6 relative">
              <label for="confirm-password" class="label sr-only"
                >Confirm Password</label
              >
              <input
                class="input input-bordered rounded-none glass w-full pr-12"
                type="password"
                id="confirm-password"
                name="confirm_password"
                placeholder="Confirm New Password"
                minlength="8"
                required
              />
              <i
                class="fas fa-eye toggle-password absolute right-3 top-1/2 transform -translate-y-1/2 cursor-pointer"
                aria-label="Toggle confirm password visibility"
                onclick="
                      (function(p, icon){
                        if (p.type === 'password') {
                          p.type = 'text';
                          icon.classList.remove('fa-eye');
                          icon.classList.add('fa-eye-slash');
                        } else {
                          p.type = 'password';
                          icon.classList.remove('fa-eye-slash');
                          icon.classList.add('fa-eye');
                        }
                      })(document.getElementById('confirm-password'), this)"
              ></i>
            </div>

            <div class="form-group form-control">
              <button class="btn btn-primary rounded-lg w-full" type="submit">
                <i class="fas fa-key"></i> Update Password
              </button>
            </div>

            <!-- Server response target for PASSWORD RESET only -->
            <div id="password-reset-response" class="mt-2 text-center"></div>
          </form>

          <div class="divider">OR</div>
          <button
            class="btn rounded-lg w-full"
            type="button"
            onclick="toggleView('login')"
          >
            Back to Login
          </button>
        </section>
      </div>
    </fieldset>
  </div>
</div>

<script>
  // Clear other response containers when performing a different action
  function clearOtherResponses(keepContainer) {
    const containers = [
      "login-response",
      "magic-response",
      "reset-response",
      "password-reset-response",
    ];
    containers.forEach((id) => {
      if (id !== keepContainer) {
        const container = document.getElementById(id);
        if (container) container.innerHTML = "";
      }
    });
  }

  // Minimal view toggle (no DOM rewrites; htmx handles requests/responses)
  function toggleView(which) {
    const views = document.querySelectorAll("[data-view]");
    views.forEach((v) => v.classList.add("hidden"));
    const el = document.getElementById(`view-${which}`);
    if (el) el.classList.remove("hidden");

    // Transfer email between views
    if (which === "reset") {
      // Transfer email from login to reset view
      const loginEmail = document.getElementById("login-username");
      const resetEmail = document.getElementById("reset-username");
      if (loginEmail && resetEmail && loginEmail.value) {
        resetEmail.value = loginEmail.value;
      }
    } else if (which === "login") {
      // Transfer email from reset to login view
      const resetEmail = document.getElementById("reset-username");
      const loginEmail = document.getElementById("login-username");
      if (resetEmail && loginEmail && resetEmail.value) {
        loginEmail.value = resetEmail.value;
      }
    }
  }

  // Validate password matching for reset form
  function validatePasswordMatch() {
    const newPassword = document.getElementById("new-password");
    const confirmPassword = document.getElementById("confirm-password");

    if (newPassword && confirmPassword) {
      if (newPassword.value !== confirmPassword.value) {
        confirmPassword.setCustomValidity("Passwords do not match");
        return false;
      } else {
        confirmPassword.setCustomValidity("");
        return true;
      }
    }
    return true;
  }

  // Check for reset token on page load and switch to password reset view
  document.addEventListener("DOMContentLoaded", function () {
    const resetToken = "{{ reset_token or '' }}";
    if (resetToken) {
      toggleView("password-reset");
    }

    // Add password validation listeners
    const newPassword = document.getElementById("new-password");
    const confirmPassword = document.getElementById("confirm-password");

    if (newPassword && confirmPassword) {
      newPassword.addEventListener("input", validatePasswordMatch);
      confirmPassword.addEventListener("input", validatePasswordMatch);
    }
  });

  // Listen for successful password reset and switch back to login view with prefilled data
  document.body.addEventListener("htmx:afterRequest", function (event) {
    const hxTrigger = event.detail.xhr.getResponseHeader("HX-Trigger");
    if (hxTrigger && hxTrigger.includes("passwordResetSuccess")) {
      try {
        // Parse the trigger data to get email and password
        const triggerData = JSON.parse(hxTrigger);
        const resetData = triggerData.passwordResetSuccess;
        
        setTimeout(function () {
          toggleView("login");
          
          // Prefill the login form with email and new password
          if (resetData && resetData.email && resetData.password) {
            const loginEmail = document.getElementById("login-username");
            const loginPassword = document.getElementById("login-password");
            
            if (loginEmail) loginEmail.value = resetData.email;
            if (loginPassword) loginPassword.value = resetData.password;
            
            // Focus on the login button or email field for better UX
            if (loginEmail) loginEmail.focus();
          }
        }, 2000); // Show success message for 2 seconds, then switch to login
      } catch (e) {
        // Fallback to old behavior if JSON parsing fails
        setTimeout(function () {
          toggleView("login");
        }, 2000);
      }
    }
  });
</script>
{% endblock %}
